#define init
global.spr_PPCarS = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAALQAAAAhCAMAAABHuHHwAAAAJ1BMVEUAAAAAAAAOHikdGhcgN0YyLitKXHxMUEFVepJ6f22nrZfF0ef///8Ade5jAAAAAXRSTlMAQObYZgAAATxJREFUeNrtleGKwyAQBltd93Pj+7/v6VFXYQlFUhNz1/nhwiDtBNLu4++Tkk5FROf1ADornjn8wuz1mggKebaLFGN0Lh90brMHfMiUqS4ozbVAdRIzROWUywNDh97zek3vbS16e1SaOx5sv9gGDjobbd1xQsen3Tf6vGj741zsnbafNy0aCC+AtjOqE/mEQ4vGkq8Hngp23HrRz46BB1kp2rpbR0tTom5T5LLoUbcFZfu/0b4pPy+amYF89NHVrRrNKSWRfHAXXd2do+3aPe6AmgKMuPevx4Q1fuIP0bnQ4VxxMfYuxknLxSsYjCYKHUR70e8fZCTQOstA9JEHORA4J9q6/ehqdgKXjI4UC3ncJ1patExJtv8ey0fbBTGy/ey9i6OZq2MeCLTuTFLyr7y28dGhjhwV8sDjyz4/X0QsN8VIuNIAAAAASUVORK5CYII=",9,10,16);
global.spr_PPCarSS = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAALQAAAAhCAMAAABHuHHwAAAACVBMVEUAAAAAAAAgN0a0luuxAAAAAXRSTlMAQObYZgAAAI5JREFUeNrt2EEKgDAMRNF4/0vrphT8AZGEDoGZjfBXry6EGn92PVvPtImXA/fyxngavYe0IhqjDlhp/W+/H8jGOAHNZrTRRhst+Azq0Gwz0YwT0GxGn2ogTkBTaLTRRLO8ljUxOmDGsiY7CJejlQcJpHY0WytQgC4A9WjOaKMLaP0lYMC/PMQ4uG+MEHgDyEwLwacWG5oAAAAASUVORK5CYII=",9,10,16);
global.spr_PPCarSW = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAALQAAAAjCAMAAAAKcND7AAAACVBMVEUAAAAgN0b///8pD6mTAAAAAXRSTlMAQObYZgAAAJRJREFUeNrt2EsKgDAQBNFh7n9oQXFVwQ8J6Rno3gi1enEhxPixPHc/h02zd2DmQ2PciiYmE5GNUQecaevf/nogG2MHNJvRRhtttOAzqEOz9UQzdkCzGb2rgdgBTaHRRgONgo1aLXR+XDAVResPcg2nWLzFaKwamjEE6GmgAD0B1KM5o42eQOuvW/X/mjLGln3F6IAHXiwdTYCYn+UAAAAASUVORK5CYII=",9,10,17);
global.msk_PPCarS = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAACEAAAAUCAMAAAA0jaRDAAAACVBMVEUAAAAAAAD///+D3c/SAAAAAXRSTlMAQObYZgAAABtJREFUeAFjGESAEReAK8ANSFUxqoJwqA8mAACs9wFBnNOX+gAAAABJRU5ErkJggg==",1,16,10);

global.spr_PPCarSOpen = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAALQAAAAhCAMAAABHuHHwAAAANlBMVEUAAAAOHikgN0YyLitMUEFVepJ6f20AAAAOHikdGhcgN0YyLitKXHxMUEFVepJ6f22nrZfF0efovlBAAAAAB3RSTlMAAAAAAAAAVWTqWAAAAXBJREFUeNrtl9uOwiAQQLtuVS4zDPz/zy6YMkMyaQzBXnQ9D0xyQvSQtBKnzyclngwRz+NB5FmxAP4BgOVtRFjIUza6EIIxeXH7NltE6zNlsvOMOAlkRyHjXFnp8EDfwPssb+N9UaLjVBE3Hqy/WAd2Oh2t3Ti+4dXuG71ftH45T/ZM68/bLBrRLyDKnVEd0SscSjSe8vHAO4Mr7nzR94aBgxwZrd1bR5MoYhcZOiy610XPxP8bbUXZ7aIBADEvbXR1Z42GlBJRXqCJru6do/W1O+4Qawpij3v+eGxwje/4IhrjG4wpLoTWhbDR5WIZ7Ix2zjc4txb9/CA9gdppOqJHDjIWOB5tGXG/jBxEXBPtFySQnHGFPIhdcKGQB7soLu4aPV8v10Ie89SBjtbuSXQ1/dE3ib5N4+ho/euhDnK66PVLI0v7WMS1gbxPHO8biB77YwtQHcDqNa4DtduTlOySJzf+3MDu8nMp5DFPX9b5A5htYcfjauFlAAAAAElFTkSuQmCC",9,10,16);
global.spr_PPCarSOpenS = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAALQAAAAhCAMAAABHuHHwAAAACVBMVEUAAAAAAAD///+D3c/SAAAAAXRSTlMAQObYZgAAAKJJREFUeAHt2DEKhEAQRFHr/pfeZIOG34FSjF1CV7R8FnkzYOL1ZJLqD7bp6Y9QBZb1DfFlNDESIhriINBoB27fxBi3n49GM7boRS960Uz5aLavopny0WyLfq+V/CU0y6LZFo1SO1vWiyisa5MHaSZs6iCI1xE0mwHMR5uHuw3EffTtxg16ny4OoN3RnI/mPDTmoY3b91+S8pjEj438X87ygT9Q2wupFzSuwQAAAABJRU5ErkJggg==",9,10,16);
global.spr_PPCarSOpenW = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAALQAAAAjCAMAAAAKcND7AAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAAAKFJREFUeNrtmEEKwCAMwOz/Pz0ELyWKGxXbsuY04pDYgwfbB6SjPuB8kREhKnCwdpRXoxVDQdJR+gVa3OnpmwIN088QTVfRFV3RFe1wDfpF0+WMpswQTVfRF53WWaK1reiKRjQMmLlY0fKSRhU22v8gHZziMIejQYZoygzRdP+I3j+QrVb37t6kGW0DO0ePJmmjOX3zdaS3ifasy/9CET/wAc9bDtlIbK+lAAAAAElFTkSuQmCC",9,10,17);

global.spr_PPCarG = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAMAAACDi47UAAAAIVBMVEUAAAAAAAAdGhcgN0YyLitKXHxMUEFVepJ6f22nrZfF0efbngpOAAAAAXRSTlMAQObYZgAAAD9JREFUeNp1zsEKACAIA9CmZdb/f3BJURb4DjuMIaYQnFv2SdUSd1cmEcu9hXJ1WGFlw6PFpRDlg0jW0U/w9wC6IQGnP4/eTwAAAABJRU5ErkJggg==",1,10,5);
global.spr_PPCarGW = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAMAAACDi47UAAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAAACNJREFUeAFjAAFGJADkQsUwRRnRAEQMU5QRC6BUEIsodicBAER/AK/qY5VuAAAAAElFTkSuQmCC",1,10,5);
global.spr_PPCarGB = sprite_add_base64("iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAMAAACDi47UAAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAAABFJREFUeAFjoCdgRAHYBSkGAAoCAB1LXHw9AAAAAElFTkSuQmCC",1,10,5);

AuditorList = [-1];
global.CarWepList = [-1];

#define step

with(GameCont) if ("PPCarMode" not in self) {
	PPCarMode = 0;
}


if (GameCont.PPCarMode != 0) {
	// /gml GameCont.PPCarMode = 3;

	/* //Look at this monster of code
	if (AuditorList[0] = -1) {
		var i = 0;
		var b = 0;
		while (i < instance_number(Player)) {
			AuditorList[b] = player_find(b);
			if (AuditorList[b].race = "auditor") {b += 1;}
			else {AuditorList[b] = -1;}
			
			i += 1;
		}
		if (AuditorList[0] = -1) {
			var i = 0;
			while (i < instance_number(Player)) {
				AuditorList[i] = player_find(i);
				i += 1;
			}
		}
	}
	*/ //Horrifying

	if ("reset" not in self) {reset = 0;}
	if ((instance_exists(GenCont)) && (reset = 0)) {
		reset = -1;
	}
	if ((!instance_exists(GenCont)) && (reset = -1)) {
		reset = 1;
		audlist = instances_matching(Player, "race", "auditor");
		if (array_length_1d(audlist) > 0) {
			driver = audlist[irandom(array_length_1d(audlist) - 1)];
		}
		else {
			driver = player_find(irandom(instance_number(Player) - 1));
		}
		//driver = AuditorList[irandom(array_length_1d(AuditorList) - 1)];
	}
	
	if (((reset)) && (!instance_exists(driver))) {
		reset = -1;
	}

	if ((reset) && (GameCont.area != 107) && (instance_exists(Floor)) && (!instance_exists(FloorMaker))) {
		PPCflip = choose(-1, 1);
		var nearestfloor = instance_nearest(driver.x + (720 * PPCflip),driver.y,Floor);
		
		PPCspawnX = nearestfloor.x + (720 * PPCflip);
		PPCspawnY = nearestfloor.y;
		PPCgoalfloor = nearestfloor;
		
		instance_create(PPCspawnX,PPCspawnY,FloorExplo);
		with(Wall) if (distance_to_point(other.PPCspawnX,other.PPCspawnY) < 30){
			instance_create(x,y,FloorExplo);
			instance_destroy();
		}
		
		with(Player) if (("inPPCar" not in self) || (inPPCar = 0)) {inPPCar = 1;}

		with instance_create(PPCspawnX, PPCspawnY, CustomObject){
			imageangle = 90 * other.PPCflip;
			if (GameCont.PPCarMode = 1) {
				fuel = 100;
				fuelmax = 100;
			}
			else if (GameCont.PPCarMode = 2) {
				fuel = 200;
				fuelmax = 200;
			}
			else {
				fuel = 20000;
				fuelmax = 20000;
			}
			
			mask_index = global.msk_PPCarS;
			
			sprMain = global.spr_PPCarS;
			sprBOut = global.spr_PPCarSS;
			sprWOut = global.spr_PPCarSW;
			
			PPCgoal = other.PPCgoalfloor;
			
			direction = imageangle + 90;
			speed = 10 + 2 * skill_get(2);
			
			steeringlocked = 1;
			
			gear = 3;
			
			team = other.driver.team;
			Driver = other.driver;
			IsPPCar = 1;
			
			script_bind_draw(drawPPCar, Driver.depth);
		}
		
		reset = 0;
		
	}

	with(CustomObject) if ("IsPPCar" in self){
		if (steeringlocked) {
			if (distance_to_object(PPCgoal) < 40) steeringlocked = 0
			with (Wall) if (distance_to_point(other.x,other.y) < 17.5) {
				instance_create(x,y,FloorExplo);
				instance_destroy();
			}
		}
		else {
			if (fuel > 0) {
				
				if (Driver != -1) with(Driver) {
					if button_pressed(index,"nort") && (other.gear < 4){
						other.gear += 1;
					}
					if button_pressed(index,"sout") && (other.gear > -1){
						other.gear -= 1;
					}
					
					if button_pressed(index,"pick") {
						other.Driver = -1;
						other.gear = 0;
					}
				}
				
				if (gear = -1) {
					targetspeed = -3 - skill_get(2);
					fuel -= 0.5 + 0.25 * skill_get(2);
				}
				if (gear = 0) {
					targetspeed = 0;
				}
				if (gear = 1) {
					targetspeed = 6 + 2 * skill_get(2);
					fuel -= 1 + 0.5 * skill_get(2);
				}
				if (gear = 2) {
					targetspeed = 9 + 3 * skill_get(2);
					fuel -= 1.5 + 0.75 * skill_get(2);
				}
				if (gear = 3) {
					targetspeed = 12 + 4 * skill_get(2);
					fuel -= 2 + skill_get(2);
				}
				if (gear = 4) {
					targetspeed = 15 + 5 * skill_get(2);
					fuel -= 3 + 1.25 * skill_get(2);
				}
					
				if (targetspeed > speed) {speed += 0.5;}
				if (targetspeed < speed) {speed -= 0.5;}
				
			}
			else {
				if (speed > 0) {speed -= 0.25;}
				if (speed < 0) {speed += 0.25;}
				if ((speed = 0) && (Driver != -1)) {
					Driver = -1;
					with(Player) if (("inPPCar" in self) && (inPPCar)){
						image_alpha = recordedalpha;
						inPPCar = 0;
					}
				}
			}
			
			if ((speed > 0.25) && (Driver != -1)) {
				direction += angle_difference(Driver.gunangle,direction)/((200 - 10 * skill_get(2))/speed);
				imageangle = direction - 90;
			}
			if ((speed < -0.25) && (Driver != -1)) {
				direction += angle_difference(Driver.gunangle,direction + 180)/((180 - 10 * skill_get(2))/(-speed));
				imageangle = direction - 90;
			}
			if (speed > 6) {
				with (Wall) if (distance_to_point(other.x,other.y) < 20) {
					instance_create(x,y,FloorExplo);
					instance_destroy();
				}
			}
			else {
				if place_meeting(x + lengthdir_x(speed,direction), y + lengthdir_y(speed,direction), Wall) {speed = 0;}
			}
		}
		
		if (speed != 0) {
			sound_play_pitchvol(sndDoubleMinigun, 0.1+abs(speed/20), 0.5);
			with(hitme) if ((distance_to_object(other) < 20) && (team != other.team) && (sprite_index != spr_hurt)){
				sprite_index = spr_hurt;
				image_index = 0;
				sound_play(snd_hurt);
				my_health -= (GameCont.level * speed);
				motion_add(direction,speed);
			}
		}
		
		with(Player) {
			if (("inPPCar" in self) && (inPPCar)){
				if ("recordedalpha" not in self) || (recordedalpha = 0){
					recordedalpha = image_alpha;
					recordedhealth = my_health;
				}

				if my_health < recordedhealth my_health = recordedhealth;
				else if my_health > recordedhealth recordedhealth = my_health;

				x = other.x;
				y = other.y;
				image_alpha = 0;
			
				if (button_pressed(index,"pick")) {
					image_alpha = recordedalpha;
					inPPCar = 0;
				}
			}
			else if ((other.fuel > 0) && ((("inPPCar" in self) && (!inPPCar)) || ("inPPCar" not in self))) {
				if ((button_pressed(index,"pick")) && (distance_to_object(other) < 10)) {
					if (other.Driver = -1) {other.Driver = self;}
					inPPCar = 1;
				}
			}
		}
		
		if ((GameCont.PPCarMode = 1) && (Driver = -1) && (sprMain != global.spr_PPCarSOpen)) {
			if (global.CarWepList[0] = -1) { // this almost definitely is not the right way to do this
				global.CarWepList = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,49,50,51,52,53,54,55,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,105,106,107,110,111,112,114,116,117,118,119,124];
				var i = 0;
				while (i <= array_length_1d(mod_get_names("weapon"))-1) {
					global.CarWepList[124+i] = mod_get_names("weapon")[i];
					i += 1;
				}
			}
		
			sprMain = global.spr_PPCarSOpen;
			sprBOut = global.spr_PPCarSOpenS;
			sprWOut = global.spr_PPCarSOpenW;
			
			sound_play_pitchvol(sndEmpty,2,0.5);
			
			if (random(1) <= 0.33) {
				repeat(2){
					with instance_create(x+lengthdir_x(20,imageangle-90),y+lengthdir_y(20,imageangle-90),BigRad){
						speed = 3;
						direction = other.imageangle-90;
					}
				}
				repeat(irandom(10)){
					with instance_create(x+lengthdir_x(20,imageangle-90),y+lengthdir_y(20,imageangle-90),Rad){
						speed = 3;
						direction = other.imageangle-90;
					}
				}
			}
			if (random(1) <= 0.33) {
				if (random(1) <= 0.125) {
					with instance_create(x+lengthdir_x(20,imageangle-90),y+lengthdir_y(20,imageangle-90),AmmoChest){
						speed = 6;
						direction = other.imageangle-90;
					}
				}
				with instance_create(x+lengthdir_x(20,imageangle-90),y+lengthdir_y(20,imageangle-90),AmmoChest){
					speed = 6;
					direction = other.imageangle-90;
				}
			}
			if (random(1) <= 0.33) {
				if (random(1) <= 0.125) {
					with instance_create(x+lengthdir_x(20,imageangle-90),y+lengthdir_y(20,imageangle-90),HealthChest){
						speed = 6;
						direction = other.imageangle-90;
					}
				}
				with instance_create(x+lengthdir_x(20,imageangle-90),y+lengthdir_y(20,imageangle-90),HealthChest){
					speed = 6;
					direction = other.imageangle-90;
				}
			}
			if (random(1) <= 0.25) {
				with instance_create(x+lengthdir_x(20,imageangle-90),y+lengthdir_y(20,imageangle-90),WepPickup){
					speed = 6;
					direction = other.imageangle-90;
					wep = 0;
					while (wep = 0 || (weapon_get_area(wep) > GameCont.hard) || (weapon_get_area(wep) < 0)) {
						wep = global.CarWepList[irandom(array_length_1d(global.CarWepList)-1)];
					}
				}
			}
			if (random(1) <= 0.05) {
				with instance_create(x+lengthdir_x(20,imageangle-90),y+lengthdir_y(20,imageangle-90),WepPickup){
					speed = 6;
					direction = other.imageangle-90;
					wep = 0;
					while (wep = 0 || weapon_get_area(wep) > GameCont.hard+2 || weapon_get_area(wep) < GameCont.hard) {
						wep = global.CarWepList[irandom(array_length_1d(global.CarWepList)-1)];
					}
				}
			}
		}
	}
}

#define drawPPCar
with(CustomObject) if ("IsPPCar" in self){
	if (Driver != -1) {
		var process = 0;
		while (process <= 8) {
			draw_sprite_ext(sprWOut, process, x, y - process, 1, 1, imageangle, player_get_color(Driver.index), 1);
			process += 1;
		}
	}
	process = 0;
	while (process <= 8) {
		draw_sprite_ext(sprBOut, process, x, y - process, 1, 1, imageangle, c_white, 1);
		process += 1;
	}
	process = 0;
	while (process <= 8) {
		draw_sprite_ext(sprMain, process, x, y - process, 1, 1, imageangle, c_white, 1);
		process += 1;
	}
}

#define draw
with(CustomObject) if (("IsPPCar" in self) && (Driver != -1)){
		draw_sprite_ext(global.spr_PPCarGW, 0, x, y - 30, 1, 1, 0, player_get_color(Driver.index), 1);
		draw_sprite_ext(global.spr_PPCarG, 0, x, y - 30, 1, 1, 0, c_white, 1);
		draw_sprite_ext(global.spr_PPCarGB, 0, x, y - 30, fuel / fuelmax, 1, 0, player_get_color(Driver.index), 1);
}